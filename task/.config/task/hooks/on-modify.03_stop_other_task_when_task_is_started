#!/usr/bin/env python3

import json
import subprocess
import sys

try:
    input_stream = sys.stdin.buffer
except AttributeError:
    input_stream = sys.stdin

def get_active_tasks():
    command = ["task", "+ACTIVE", "export"]
    result = subprocess.run(command, capture_output=True, text=True)

    if result.returncode == 0:
        active_tasks = json.loads(result.stdout)
    else:
        print(f"Command failed with return code {result.returncode}")
        print(f"Error: {result.stderr}")

    return active_tasks

def stop_all_active_tasks():
    tasks = get_active_tasks()
    for t in tasks:
        command = f"task {t['uuid']} stop"
        subprocess.call(command, shell=True)

def main(old, new):
    if 'start' in new and 'start' not in old:
        stop_all_active_tasks()

if __name__ == "__main__":
    old = json.loads(input_stream.readline().decode("utf-8", errors="replace"))
    new = json.loads(input_stream.readline().decode("utf-8", errors="replace"))
    print(json.dumps(new))
    main(old, new)

